
# HG changeset patch
# User Todd C. Miller <Todd.Miller@courtesan.com>
# Date 1476033869 21600
# Node ID 5d88d7cda853a5f6787f4d9145f3a0c04986370a
# Parent  59d76bdc0f0c2841596e6c6c681ee4edc87a64da
Fix configure check for seccomp filter on Linux

Index: sudo-1.8.16/config.h.in
===================================================================
--- sudo-1.8.16.orig/config.h.in	2019-05-01 11:30:12.391005557 -0400
+++ sudo-1.8.16/config.h.in	2019-05-01 11:30:12.387005549 -0400
@@ -124,6 +124,10 @@
    don't. */
 #undef HAVE_DECL_QUAD_MIN
 
+/* Define to 1 if you have the declaration of `SECCOMP_SET_MODE_FILTER', and
+   to 0 if you don't. */
+#undef HAVE_DECL_SECCOMP_SET_MODE_FILTER
+
 /* Define to 1 if you have the declaration of `setauthdb', and to 0 if you
    don't. */
 #undef HAVE_DECL_SETAUTHDB
@@ -526,9 +530,6 @@
 /* Define to 1 if you have the `posix_spawnp' function. */
 #undef HAVE_POSIX_SPAWNP
 
-/* Define to 1 if you have the `prctl' function. */
-#undef HAVE_PRCTL
-
 /* Define to 1 if you have the `pread' function. */
 #undef HAVE_PREAD
 
Index: sudo-1.8.16/configure
===================================================================
--- sudo-1.8.16.orig/configure	2019-05-01 11:30:12.391005557 -0400
+++ sudo-1.8.16/configure	2019-05-01 11:30:12.391005557 -0400
@@ -15199,22 +15199,24 @@ fi
     *-*-linux*|*-*-k*bsd*-gnu)
 		shadow_funcs="getspnam"
 		test -z "$with_pam" && AUTH_EXCL_DEF="PAM"
-		# Check for linux/filter.h and prctl to use seccomp(2)
-		ac_fn_c_check_header_mongrel "$LINENO" "linux/filter.h" "ac_cv_header_linux_filter_h" "$ac_includes_default"
-if test "x$ac_cv_header_linux_filter_h" = xyes; then :
-  for ac_func in prctl
-do :
-  ac_fn_c_check_func "$LINENO" "prctl" "ac_cv_func_prctl"
-if test "x$ac_cv_func_prctl" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_PRCTL 1
-_ACEOF
-
-fi
-done
+		# Check for SECCOMP_SET_MODE_FILTER in linux/seccomp.h
+		ac_fn_c_check_decl "$LINENO" "SECCOMP_SET_MODE_FILTER" "ac_cv_have_decl_SECCOMP_SET_MODE_FILTER" "
+#include <sys/types.h>
+#include <sys/prctl.h>
+#include <asm/unistd.h>
+#include <linux/seccomp.h>
+#include <linux/filter.h>
 
+"
+if test "x$ac_cv_have_decl_SECCOMP_SET_MODE_FILTER" = xyes; then :
+  ac_have_decl=1
+else
+  ac_have_decl=0
 fi
 
+cat >>confdefs.h <<_ACEOF
+#define HAVE_DECL_SECCOMP_SET_MODE_FILTER $ac_have_decl
+_ACEOF
 
 		;;
     *-*-gnu*)
Index: sudo-1.8.16/configure.ac
===================================================================
--- sudo-1.8.16.orig/configure.ac	2019-05-01 11:30:12.391005557 -0400
+++ sudo-1.8.16/configure.ac	2019-05-01 11:30:12.391005557 -0400
@@ -1949,8 +1949,14 @@ case "$host" in
     *-*-linux*|*-*-k*bsd*-gnu)
 		shadow_funcs="getspnam"
 		test -z "$with_pam" && AUTH_EXCL_DEF="PAM"
-		# Check for linux/filter.h and prctl to use seccomp(2)
-		AC_CHECK_HEADER([linux/filter.h], [AC_CHECK_FUNCS([prctl])])
+		# Check for SECCOMP_SET_MODE_FILTER in linux/seccomp.h
+		AC_CHECK_DECLS([SECCOMP_SET_MODE_FILTER], [], [], [
+#include <sys/types.h>
+#include <sys/prctl.h>
+#include <asm/unistd.h>
+#include <linux/seccomp.h>
+#include <linux/filter.h>
+		])
 		;;
     *-*-gnu*)
 		# lockf() is broken on the Hurd
Index: sudo-1.8.16/src/sudo_noexec.c
===================================================================
--- sudo-1.8.16.orig/src/sudo_noexec.c	2019-05-01 11:30:12.391005557 -0400
+++ sudo-1.8.16/src/sudo_noexec.c	2019-05-01 11:30:12.391005557 -0400
@@ -18,10 +18,9 @@
 
 #include <sys/types.h>
 
-#if defined(__linux__) && defined(HAVE_PRCTL)
+#if defined(HAVE_DECL_SECCOMP_SET_MODE_FILTER) && HAVE_DECL_SECCOMP_SET_MODE_FILTER
 # include <sys/prctl.h>
 # include <asm/unistd.h>
-# include <linux/audit.h>
 # include <linux/filter.h>
 # include <linux/seccomp.h>
 #endif
@@ -216,7 +215,7 @@ INTERPOSE(wordexp)
 /*
  * On Linux we can use a seccomp() filter to disable exec.
  */
-#if defined(__linux) && defined(HAVE_PRCTL)
+#if defined(HAVE_DECL_SECCOMP_SET_MODE_FILTER) && HAVE_DECL_SECCOMP_SET_MODE_FILTER
 
 /* Older systems may not support execveat(2). */
 #ifndef __NR_execveat
@@ -251,4 +250,4 @@ noexec_ctor(void)
     if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) == 0)
 	(void)prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &exec_fprog);
 }
-#endif /* __linux__ && HAVE_PRCTL */
+#endif /* HAVE_DECL_SECCOMP_SET_MODE_FILTER */
